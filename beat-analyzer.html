<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>BEAT 多週期支撐 / 壓力分析</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- PWA manifest -->
  <link rel="manifest" href="manifest.json" />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      background: #0b1020;
      color: #f5f5f5;
    }
    h1 {
      font-size: 20px;
      margin-bottom: 8px;
    }
    .layout {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(260px, 1fr);
      gap: 12px;
    }
    @media (max-width: 900px) {
      .layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }
    .card {
      background: #151a30;
      border-radius: 12px;
      padding: 12px 16px;
      margin-bottom: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.4);
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }
    label {
      font-size: 14px;
      margin-right: 4px;
    }
    input, select, button {
      border-radius: 8px;
      border: 1px solid #444;
      padding: 6px 10px;
      background: #101425;
      color: #f5f5f5;
      font-size: 14px;
    }
    button {
      cursor: pointer;
      border-color: #2e7dfb;
    }
    button:hover {
      background: #1a2a4f;
    }
    .info-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      font-size: 14px;
    }
    .info-item span {
      display: block;
    }
    .label {
      color: #a5acc7;
      font-size: 12px;
    }
    .value-up {
      color: #4ade80;
      font-weight: 600;
    }
    .value-down {
      color: #f97373;
      font-weight: 600;
    }
    .value-neutral {
      color: #e5e7eb;
      font-weight: 600;
    }
    canvas {
      max-height: 340px;
    }
    small {
      color: #9ca3af;
      font-size: 11px;
    }
    .breakout {
      margin-top: 6px;
      font-size: 13px;
    }
    .breakout.up {
      color: #4ade80;
    }
    .breakout.down {
      color: #f97373;
    }
    .breakout.neutral {
      color: #e5e7eb;
    }
    .watchlist-title {
      font-size: 14px;
      margin-bottom: 6px;
      color: #a5acc7;
    }
    .watchlist {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .watch-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 8px;
      border-radius: 8px;
      background: #101425;
      cursor: pointer;
    }
    .watch-item-left {
      display: flex;
      flex-direction: column;
    }
    .watch-item-symbol {
      font-size: 13px;
      font-weight: 600;
    }
    .watch-item-pos {
      font-size: 12px;
    }
    .watch-item-delete {
      border-radius: 999px;
      border: 1px solid #444;
      background: #251018;
      color: #f97373;
      font-size: 11px;
      padding: 2px 8px;
      cursor: pointer;
    }
    .watch-item-delete:hover {
      background: #7f1d1d;
      border-color: #f97373;
    }
    .watchlist-add-row {
      display: flex;
      gap: 6px;
      margin-bottom: 8px;
      align-items: center;
    }
    .watchlist-add-row input {
      flex: 1;
      font-size: 13px;
    }
    .watchlist-hint {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 4px;
    }
    /* 週期按鈕列 */
    .tf-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
      margin-top: 8px;
    }
    .tf-label {
      font-size: 14px;
      color: #a5acc7;
      margin-right: 4px;
    }
    .tf-btn {
      border-radius: 999px;
      border: 1px solid #444;
      padding: 4px 10px;
      background: #101425;
      color: #e5e7eb;
      font-size: 13px;
      cursor: pointer;
    }
    .tf-btn.active {
      background: #2e7dfb;
      border-color: #2e7dfb;
      color: white;
      font-weight: 600;
    }
    /* 計算機樣式 */
    .calc-title {
      font-size: 14px;
      margin-bottom: 6px;
      color: #e5e7eb;
      font-weight: 600;
    }
    .calc-section {
      border-top: 1px solid #1f2937;
      margin-top: 8px;
      padding-top: 8px;
    }
    .calc-row {
      display: flex;
      gap: 6px;
      margin-bottom: 6px;
    }
    .calc-row label {
      min-width: 90px;
      font-size: 13px;
      color: #a5acc7;
    }
    .calc-row input {
      flex: 1;
      font-size: 13px;
    }
    .calc-output {
      font-size: 13px;
      margin-top: 2px;
    }
    .calc-output span {
      display: block;
    }
  </style>
</head>
<body>
  <h1>BEAT 多週期支撐 / 壓力分析</h1>

  <div class="layout">
    <!-- 左側：主要圖表區 -->
    <div>
      <div class="card">
        <div class="row">
          <label for="symbol">交易對：</label>
          <input id="symbol" type="text" value="BEATUSDT" />
          <label for="limit">K 總數量：</label>
          <select id="limit">
            <option value="50">50 根 (短線)</option>
            <option value="100" selected>100 根</option>
            <option value="200">200 根</option>
          </select>
          <button id="loadBtn">重新載入</button>
        </div>
        <!-- 多週期按鈕：5m / 15m / 1H / 4H / 1D -->
        <div class="tf-row">
          <span class="tf-label">時間週期：</span>
          <button class="tf-btn active" data-interval="5m">5m</button>
          <button class="tf-btn" data-interval="15m">15m</button>
          <button class="tf-btn" data-interval="1h">1H</button>
          <button class="tf-btn" data-interval="4h">4H</button>
          <button class="tf-btn" data-interval="1d">1D</button>
        </div>
        <small>資料來源：Binance 公開 API。時間週期可切換，MACD / RSI 亦使用相同週期。自動刷新間隔：30 秒（當前週期）。</small>
      </div>

      <div class="card">
        <div class="info-grid">
          <div class="info-item">
            <span class="label">目前價格</span>
            <span id="currentPrice" class="value-neutral">--</span>
          </div>
          <div class="info-item">
            <span class="label">簡易支撐（近 N 根較低價平均）</span>
            <span id="support" class="value-up">--</span>
          </div>
          <div class="info-item">
            <span class="label">簡易壓力（近 N 根較高價平均）</span>
            <span id="resistance" class="value-down">--</span>
          </div>
          <div class="info-item">
            <span class="label">目前位置判斷</span>
            <span id="position" class="value-neutral">--</span>
          </div>
        </div>
        <div id="breakoutMsg" class="breakout neutral">--</div>
      </div>

      <div class="card">
        <canvas id="priceChart"></canvas>
      </div>

      <div class="card">
        <canvas id="macdChart"></canvas>
      </div>

      <div class="card">
        <canvas id="rsiChart"></canvas>
      </div>
    </div>

    <!-- 右側：多幣監控區 + 計算機 -->
    <div>
      <div class="card">
        <div class="watchlist-title">監控清單（點一下切換到該幣）</div>

        <div class="watchlist-add-row">
          <input id="watchAddInput" type="text" placeholder="輸入幣種，例如：BEATUSDT / BTCUSDT" />
          <button id="watchAddBtn">新增</button>
        </div>
        <div class="watchlist-hint">提示：幣種需為幣安現貨交易對 Symbol（USDT 報價為主）。</div>

        <div class="watchlist" id="watchlist"></div>
      </div>

      <!-- 倉位計算機 -->
      <div class="card">
        <div class="calc-title">倉位計算機</div>

        <div class="calc-row">
          <label for="feeRate">手續費率(單邊)%</label>
          <input id="feeRate" type="number" step="0.01" value="0.1" />
        </div>
        <small>說明：0.1 代表 0.1%（預設幣安現貨單邊 0.1%，開倉與平倉各收一次）。</small>

        <!-- 區塊 1：單次開/平倉收益 -->
        <div class="calc-section">
          <div class="calc-title">單次交易收益試算（現貨多單）</div>

          <div class="calc-row">
            <label for="openPrice">開倉價格</label>
            <input id="openPrice" type="number" step="0.00001" placeholder="例如 0.73000" />
          </div>
          <div class="calc-row">
            <label for="closePrice">平倉價格</label>
            <input id="closePrice" type="number" step="0.00001" placeholder="例如 0.76000" />
          </div>
          <div class="calc-row">
            <label for="amountUSDT">成交金額(USDT)</label>
            <input id="amountUSDT" type="number" step="0.01" placeholder="例如 100（用多少 USDT 買入）" />
          </div>
          <button id="calcSingleBtn" style="margin-top:6px;">計算收益</button>

          <div class="calc-output" id="singleResult">
            <span>成交數量(幣)：--</span>
            <span>毛利(未扣手續費)：--</span>
            <span>手續費總額(USDT)：--</span>
            <span>淨收益(USDT)：--</span>
          </div>
        </div>

        <!-- 區塊 2：增加倉位後均價 -->
        <div class="calc-section">
          <div class="calc-title">增加倉位後的均價</div>

          <div class="calc-row">
            <label for="curAvgPrice">現持倉均價</label>
            <input id="curAvgPrice" type="number" step="0.00001" placeholder="例如 0.72000" />
          </div>
          <div class="calc-row">
            <label for="curAmountUSDT">現持倉成本(USDT)</label>
            <input id="curAmountUSDT" type="number" step="0.01" placeholder="例如 200（目前花了多少 USDT）" />
          </div>
          <div class="calc-row">
            <label for="addPrice">新增價格</label>
            <input id="addPrice" type="number" step="0.00001" placeholder="例如 0.70000" />
          </div>
          <div class="calc-row">
            <label for="addAmountUSDT">新增金額(USDT)</label>
            <input id="addAmountUSDT" type="number" step="0.01" placeholder="例如 100（再買多少 USDT）" />
          </div>

          <button id="calcDCAButton" style="margin-top:6px;">計算新均價</button>

          <div class="calc-output" id="dcaResult">
            <span>新持倉總成本(USDT)：--</span>
            <span>新持倉總幣數：--</span>
            <span>新持倉均價：--</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // --- 基本設定 ---
    const apiBase = "https://api.binance.com";
    const AUTO_REFRESH_MS = 30000; // 自動刷新間隔（毫秒）

    const symbolInput = document.getElementById("symbol");
    const limitSelect  = document.getElementById("limit");
    const loadBtn      = document.getElementById("loadBtn");

    const currentPriceEl = document.getElementById("currentPrice");
    const supportEl      = document.getElementById("support");
    const resistanceEl   = document.getElementById("resistance");
    const positionEl     = document.getElementById("position");
    const breakoutMsgEl  = document.getElementById("breakoutMsg");

    const tfButtons = document.querySelectorAll(".tf-btn");

    const watchAddInput = document.getElementById("watchAddInput");
    const watchAddBtn   = document.getElementById("watchAddBtn");
    const watchlistContainer = document.getElementById("watchlist");

    // 計算機 DOM
    const feeRateInput      = document.getElementById("feeRate");
    const openPriceInput    = document.getElementById("openPrice");
    const closePriceInput   = document.getElementById("closePrice");
    const amountUSDTInput   = document.getElementById("amountUSDT");
    const calcSingleBtn     = document.getElementById("calcSingleBtn");
    const singleResultEl    = document.getElementById("singleResult");

    const curAvgPriceInput  = document.getElementById("curAvgPrice");
    const curAmountUSDTInput= document.getElementById("curAmountUSDT");
    const addPriceInput     = document.getElementById("addPrice");
    const addAmountUSDTInput= document.getElementById("addAmountUSDT");
    const calcDCAButton     = document.getElementById("calcDCAButton");
    const dcaResultEl       = document.getElementById("dcaResult");

    let priceChart, macdChart, rsiChart;
    let autoTimer = null;
    let currentInterval = "5m"; // 預設 5m

    // 從 localStorage 讀取監控清單，沒有就用預設
    function loadWatchlistFromStorage() {
      try {
        const raw = localStorage.getItem("beat_watchlist");
        if (raw) {
          const parsed = JSON.parse(raw);
          if (Array.isArray(parsed) && parsed.length > 0) {
            return parsed;
          }
        }
      } catch (e) {
        console.warn("讀取 watchlist 失敗，使用預設值。", e);
      }
      return ["BEATUSDT", "BTCUSDT", "ETHUSDT"];
    }

    function saveWatchlistToStorage() {
      try {
        localStorage.setItem("beat_watchlist", JSON.stringify(watchlistSymbols));
      } catch (e) {
        console.warn("儲存 watchlist 失敗。", e);
      }
    }

    let watchlistSymbols = loadWatchlistFromStorage();

    // --- API ---
    async function fetchKlines(symbol, interval, limit = 100) {
      const url = `${apiBase}/api/v3/klines?symbol=${symbol}&interval=${interval}&limit=${limit}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error("Binance API error: " + res.status);
      return res.json();
    }

    // --- 計算支撐 / 壓力 ---
    function calcSupportResistance(klines) {
      const lows  = klines.map(k => parseFloat(k[3]));
      const highs = klines.map(k => parseFloat(k[2]));
      const sortAsc  = arr => [...arr].sort((a, b) => a - b);
      const sortDesc = arr => [...arr].sort((a, b) => b - a);
      const n = Math.min(5, klines.length);
      const lowSamples  = sortAsc(lows).slice(0, n);
      const highSamples = sortDesc(highs).slice(0, n);
      const avg = arr => arr.reduce((s, v) => s + v, 0) / arr.length;
      return { support: avg(lowSamples), resistance: avg(highSamples) };
    }

    // --- MACD / RSI 計算 ---
    function ema(values, period) {
      const k = 2 / (period + 1);
      let emaArr = [];
      let prev;
      values.forEach((v, i) => {
        if (i === 0) prev = v;
        else prev = v * k + prev * (1 - k);
        emaArr.push(prev);
      });
      return emaArr;
    }

    function calcMACD(closes) {
      const ema12 = ema(closes, 12);
      const ema26 = ema(closes, 26);
      const macdLine = closes.map((_, i) => ema12[i] - ema26[i]);
      const signalLine = ema(macdLine, 9);
      const hist = macdLine.map((v, i) => v - signalLine[i]);
      return { macdLine, signalLine, hist };
    }

    function calcRSI(closes, period = 14) {
      let gains = [];
      let losses = [];
      for (let i = 1; i < closes.length; i++) {
        const diff = closes[i] - closes[i - 1];
        gains.push(Math.max(diff, 0));
        losses.push(Math.max(-diff, 0));
      }
      let avgGain = gains.slice(0, period).reduce((a, b) => a + b, 0) / period;
      let avgLoss = losses.slice(0, period).reduce((a, b) => a + b, 0) / period;
      let rsi = [];
      rsi[period] = 100 - 100 / (1 + (avgGain / (avgLoss || 1e-10)));
      for (let i = period + 1; i < closes.length; i++) {
        avgGain = (avgGain * (period - 1) + gains[i - 1]) / period;
        avgLoss = (avgLoss * (period - 1) + losses[i - 1]) / period;
        const rs = avgGain / (avgLoss || 1e-10);
        rsi[i] = 100 - 100 / (1 + rs);
      }
      return rsi;
    }

    // --- 更新 summary + 突破判斷 ---
    function updateSummary(lastClose, support, resistance) {
      const format = v => (v || v === 0) ? v.toFixed(5) : "--";
      currentPriceEl.textContent = format(lastClose);
      supportEl.textContent      = format(support);
      resistanceEl.textContent   = format(resistance);

      if (!lastClose || !support || !resistance) {
        positionEl.textContent = "--";
        positionEl.className   = "value-neutral";
        breakoutMsgEl.textContent = "--";
        breakoutMsgEl.className   = "breakout neutral";
        return;
      }

      const range = resistance - support;
      const pos   = (lastClose - support) / (range || 1);

      // 區間位置
      if (lastClose <= support * 1.01) {
        positionEl.textContent = "接近支撐區（容易反彈也容易跌破）";
        positionEl.className   = "value-up";
      } else if (lastClose >= resistance * 0.99) {
        positionEl.textContent = "接近壓力區（注意獲利了結與回落風險）";
        positionEl.className   = "value-down";
      } else if (pos < 0.4) {
        positionEl.textContent = "偏支撐區下半部（略偏多）";
        positionEl.className   = "value-up";
      } else if (pos > 0.6) {
        positionEl.textContent = "偏壓力區上半部（略偏空）";
        positionEl.className   = "value-down";
      } else {
        positionEl.textContent = "區間中段（盤整）";
        positionEl.className   = "value-neutral";
      }

      // 突破判斷
      if (lastClose > resistance * 1.01) {
        breakoutMsgEl.textContent = "已明顯突破壓力區，上攻動能較強，但容易回測壓力變支撐。";
        breakoutMsgEl.className   = "breakout up";
      } else if (lastClose < support * 0.99) {
        breakoutMsgEl.textContent = "已明顯跌破支撐區，注意續跌與反彈只當解套。";
        breakoutMsgEl.className   = "breakout down";
      } else {
        breakoutMsgEl.textContent = "目前仍在支撐與壓力區間內，屬於區間震盪。";
        breakoutMsgEl.className   = "breakout neutral";
      }
    }

    // --- 價格圖（線圖 + 支撐 / 壓力線）---
    function renderPriceChart(klines, symbol, support, resistance) {
      const labels = klines.map(k => {
        const d = new Date(k[0]);
        return `${d.getHours()}:${String(d.getMinutes()).padStart(2, "0")}`;
      });
      const closes = klines.map(k => parseFloat(k[4]));

      const ctx = document.getElementById("priceChart").getContext("2d");
      if (priceChart) priceChart.destroy();

      const supportArr    = closes.map(() => support);
      const resistanceArr = closes.map(() => resistance);

      priceChart = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [
            {
              label: `${symbol} 收盤價 (${currentInterval})`,
              data: closes,
              borderWidth: 1.5,
              pointRadius: 0,
              tension: 0.2
            },
            {
              label: "支撐",
              data: supportArr,
              borderWidth: 1,
              pointRadius: 0,
              borderDash: [4, 4]
            },
            {
              label: "壓力",
              data: resistanceArr,
              borderWidth: 1,
              pointRadius: 0,
              borderDash: [4, 4]
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            x: {
              ticks: { color: "#9ca3af", maxTicksLimit: 8 }
            },
            y: {
              ticks: { color: "#9ca3af" }
            }
          },
          plugins: {
            legend: { labels: { color: "#e5e7eb" } }
          }
        }
      });
    }

    // --- MACD & RSI 圖 ---
    function renderMacdChart(labels, macdLine, signalLine, hist) {
      const ctx = document.getElementById("macdChart").getContext("2d");
      if (macdChart) macdChart.destroy();

      macdChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [
            {
              type: "bar",
              label: "MACD Hist",
              data: hist,
              borderWidth: 0
            },
            {
              type: "line",
              label: "MACD",
              data: macdLine,
              borderWidth: 1.2,
              pointRadius: 0
            },
            {
              type: "line",
              label: "Signal",
              data: signalLine,
              borderWidth: 1.2,
              pointRadius: 0
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            x: { ticks: { color: "#9ca3af", maxTicksLimit: 8 } },
            y: { ticks: { color: "#9ca3af" } }
          },
          plugins: {
            legend: { labels: { color: "#e5e7eb" } },
            title: {
              display: true,
              text: `MACD (12,26,9) ＠ ${currentInterval}`,
              color: "#e5e7eb"
            }
          }
        }
      });
    }

    function renderRsiChart(labels, rsi) {
      const ctx = document.getElementById("rsiChart").getContext("2d");
      if (rsiChart) rsiChart.destroy();

      const rsiClean = rsi.map(v => (v === undefined ? null : v));

      rsiChart = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [
            {
              label: `RSI(14) ＠ ${currentInterval}`,
              data: rsiClean,
              borderWidth: 1.5,
              pointRadius: 0,
              tension: 0.2
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            x: { ticks: { color: "#9ca3af", maxTicksLimit: 8 } },
            y: {
              ticks: { color: "#9ca3af" },
              min: 0,
              max: 100
            }
          },
          plugins: {
            legend: { labels: { color: "#e5e7eb" } },
            title: {
              display: true,
              text: "RSI(14)",
              color: "#e5e7eb"
            }
          }
        }
      });
    }

    // --- 主加載流程 ---
    async function loadData(showLoading = true) {
      const symbol = symbolInput.value.trim().toUpperCase();
      const limit  = parseInt(limitSelect.value, 10) || 100;

      if (showLoading) {
        currentPriceEl.textContent =
          supportEl.textContent =
          resistanceEl.textContent =
          positionEl.textContent =
          breakoutMsgEl.textContent =
            "載入中…";
      }

      try {
        const klines = await fetchKlines(symbol, currentInterval, limit);
        if (!Array.isArray(klines) || klines.length === 0) {
          throw new Error("無資料");
        }

        const last = klines[klines.length - 1];
        const lastClose = parseFloat(last[4]);
        const { support, resistance } = calcSupportResistance(klines);
        const closes = klines.map(k => parseFloat(k[4]));
        const labels = klines.map(k => {
          const d = new Date(k[0]);
          return `${d.getHours()}:${String(d.getMinutes()).padStart(2, "0")}`;
        });

        updateSummary(lastClose, support, resistance);
        renderPriceChart(klines, symbol, support, resistance);

        const { macdLine, signalLine, hist } = calcMACD(closes);
        renderMacdChart(labels, macdLine, signalLine, hist);

        const rsi = calcRSI(closes, 14);
        renderRsiChart(labels, rsi);

        updateWatchlist(); // 右邊列表（固定用 5m 概略看）
      } catch (err) {
        console.error(err);
        currentPriceEl.textContent = "取得資料失敗";
        supportEl.textContent      = "--";
        resistanceEl.textContent   = "--";
        positionEl.textContent     = "--";
        breakoutMsgEl.textContent  = "--";
      }
    }

    // --- 自動刷新 ---
    function startAutoRefresh() {
      if (autoTimer) clearInterval(autoTimer);
      autoTimer = setInterval(() => loadData(false), AUTO_REFRESH_MS);
    }

    // --- 右側多幣監控 (固定 5m 短線概況) ---
    async function loadSymbolSummary(symbol) {
      try {
        const klines = await fetchKlines(symbol, "5m", 50);
        if (!Array.isArray(klines) || klines.length === 0) return null;
        const last = klines[klines.length - 1];
        const lastClose = parseFloat(last[4]);
        const { support, resistance } = calcSupportResistance(klines);
        const range = resistance - support;
        const pos   = (lastClose - support) / (range || 1);
        let posText;
        if (lastClose <= support * 1.01)          posText = "支撐附近";
        else if (lastClose >= resistance * 0.99)  posText = "壓力附近";
        else if (pos < 0.4)                       posText = "偏多區";
        else if (pos > 0.6)                       posText = "偏空區";
        else                                      posText = "盤整";
        return { symbol, lastClose, posText };
      } catch {
        return null;
      }
    }

    async function updateWatchlist() {
      watchlistContainer.innerHTML = "";
      for (const sym of watchlistSymbols) {
        const itemData = await loadSymbolSummary(sym);

        const div  = document.createElement("div");
        div.className = "watch-item";

        // 左邊：symbol + 位置
        const left = document.createElement("div");
        left.className = "watch-item-left";
        const symSpan = document.createElement("span");
        symSpan.className = "watch-item-symbol";
        symSpan.textContent = sym;

        const posSpan = document.createElement("span");
        posSpan.className = "watch-item-pos";
        if (itemData) {
          posSpan.textContent = `${itemData.lastClose.toFixed(5)}｜${itemData.posText}`;
        } else {
          posSpan.textContent = "載入失敗";
        }
        left.appendChild(symSpan);
        left.appendChild(posSpan);

        // 右邊：刪除按鈕
        const delBtn = document.createElement("button");
        delBtn.className = "watch-item-delete";
        delBtn.textContent = "✕";
        delBtn.title = "刪除此幣種";
        delBtn.addEventListener("click", (e) => {
          e.stopPropagation(); // 避免觸發切換
          const idx = watchlistSymbols.indexOf(sym);
          if (idx >= 0) {
            watchlistSymbols.splice(idx, 1);
            saveWatchlistToStorage();
            updateWatchlist();
          }
        });

        // 點整行切換主圖
        div.addEventListener("click", () => {
          symbolInput.value = sym;
          loadData(true);
        });

        div.appendChild(left);
        div.appendChild(delBtn);
        watchlistContainer.appendChild(div);
      }
    }

    // --- 新增幣種到監控清單 ---
    function addSymbolToWatchlist() {
      let sym = watchAddInput.value.trim().toUpperCase();
      if (!sym) return;
      if (!sym.endsWith("USDT")) {
        // 幫忙補 USDT（你輸入 BEAT 也會變 BEATUSDT）
        sym = sym + "USDT";
      }
      if (!watchlistSymbols.includes(sym)) {
        watchlistSymbols.push(sym);
        saveWatchlistToStorage();
        updateWatchlist();
      }
      watchAddInput.value = "";
    }

    // --- 計算機：單次開/平倉收益 ---
    function calcSingleTrade() {
      const open  = parseFloat(openPriceInput.value);
      const close = parseFloat(closePriceInput.value);
      const amt   = parseFloat(amountUSDTInput.value);
      const feeR  = parseFloat(feeRateInput.value);

      if (!(open > 0) || !(close > 0) || !(amt > 0)) {
        singleResultEl.innerHTML =
          "<span>請輸入 開倉價 / 平倉價 / 成交金額(USDT)。</span>";
        return;
      }

      const qty = amt / open;                  // 買到幣數
      const grossSell = qty * close;           // 平倉毛金額
      const grossProfit = grossSell - amt;     // 未扣手續費毛利

      const feeRate = (feeR || 0) / 100;       // 轉成小數
      const feeOpen  = amt * feeRate;          // 開倉手續費
      const feeClose = grossSell * feeRate;    // 平倉手續費
      const totalFee = feeOpen + feeClose;     // 總手續費
      const netProfit = grossProfit - totalFee;

      singleResultEl.innerHTML =
        `<span>成交數量(幣)：${qty.toFixed(6)}</span>` +
        `<span>毛利(未扣手續費)：${grossProfit.toFixed(4)} USDT</span>` +
        `<span>手續費總額(USDT)：${totalFee.toFixed(4)} USDT</span>` +
        `<span>淨收益(USDT)：${netProfit.toFixed(4)} USDT</span>`;
    }

    // --- 計算機：加倉後均價 ---
    function calcDca() {
      const curAvg   = parseFloat(curAvgPriceInput.value);
      const curAmt   = parseFloat(curAmountUSDTInput.value);
      const addPrice = parseFloat(addPriceInput.value);
      const addAmt   = parseFloat(addAmountUSDTInput.value);

      if (!(curAvg > 0) || !(curAmt >= 0) || !(addPrice > 0) || !(addAmt > 0)) {
        dcaResultEl.innerHTML =
          "<span>請輸入 現持倉均價 / 現持倉成本 / 新增價格 / 新增金額。</span>";
        return;
      }

      // 現有幣數
      const curQty = curAmt / curAvg;
      // 新增幣數
      const addQty = addAmt / addPrice;

      const totalAmt = curAmt + addAmt;
      const totalQty = curQty + addQty;
      const newAvg   = totalAmt / totalQty;

      dcaResultEl.innerHTML =
        `<span>新持倉總成本(USDT)：${totalAmt.toFixed(4)} USDT</span>` +
        `<span>新持倉總幣數：${totalQty.toFixed(6)}</span>` +
        `<span>新持倉均價：${newAvg.toFixed(6)}</span>`;
    }

    // --- 綁定事件 + 初始化 ---

    // 週期按鈕
    tfButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const interval = btn.getAttribute("data-interval");
        currentInterval = interval;
        // 切換 active 樣式
        tfButtons.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        // 重新載入資料
        loadData(true);
        startAutoRefresh();
      });
    });

    loadBtn.addEventListener("click", () => {
      loadData(true);
      startAutoRefresh();
    });

    limitSelect.addEventListener("change", () => {
      loadData(true);
    });

    watchAddBtn.addEventListener("click", addSymbolToWatchlist);
    watchAddInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") addSymbolToWatchlist();
    });

    // 計算機事件
    calcSingleBtn.addEventListener("click", calcSingleTrade);
    calcDCAButton.addEventListener("click", calcDca);

    // 頁面載入時先跑一次
    loadData(true);
    startAutoRefresh();
    updateWatchlist();

    // --- PWA Service Worker 註冊 ---
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("sw.js").catch(console.error);
    }
  </script>
</body>
</html>
